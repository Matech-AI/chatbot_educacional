name: Deploy to Hostinger
on:
  push:
    branches: [main]
  workflow_dispatch: # Permite execuÃ§Ã£o manual

jobs:
  deploy:
    runs-on: ubuntu-latest
    name: Deploy to Hostinger VPS

    steps:
      - name: ğŸš€ Deploy to Hostinger
        uses: appleboy/ssh-action@v0.1.5
        with:
          host: ${{ secrets.HOSTINGER_HOST }}
          username: ${{ secrets.HOSTINGER_USER }}
          key: ${{ secrets.HOSTINGER_SSH_KEY }}
          port: 22
          script: |
            echo "ğŸš€ DEPLOY AUTOMÃTICO INICIADO - $(date)"
            echo "=========================================="

            # Navegar para o diretÃ³rio do projeto
            cd /root/dna-forca-complete

            # Verificar status atual
            echo "ğŸ“Š Status atual do sistema:"
            ./status.sh

            # Backup nÃ£o Ã© necessÃ¡rio - cÃ³digo estÃ¡ no GitHub
            echo "ğŸ’¾ Pulando backup (cÃ³digo disponÃ­vel no GitHub)"

            # Parar sistema atual
            echo "ğŸ›‘ Parando sistema atual..."
            ./stop_all.sh

            # Aguardar processos terminarem
            sleep 5

            # Fazer pull das mudanÃ§as
            echo "ğŸ“¥ Atualizando cÃ³digo do GitHub..."
            git fetch origin
            git reset --hard origin/main

            # Verificar se hÃ¡ mudanÃ§as
            if [ $? -eq 0 ]; then
              echo "âœ… CÃ³digo atualizado com sucesso!"
            else
              echo "âŒ Erro ao atualizar cÃ³digo!"
              exit 1
            fi

            # Verificar estrutura do projeto
            echo "ğŸ” Verificando estrutura do projeto..."
            if [ -d "src" ]; then
              echo "âœ… Frontend (src/) encontrado"
            else
              echo "âŒ Frontend (src/) nÃ£o encontrado!"
              exit 1
            fi

            if [ -d "backend" ]; then
              echo "âœ… Backend encontrado"
            else
              echo "âŒ Backend nÃ£o encontrado!"
              exit 1
            fi

            # Verificar scripts
            if [ -f "start_all.sh" ] && [ -f "stop_all.sh" ] && [ -f "status.sh" ]; then
              echo "âœ… Scripts de gerenciamento encontrados"
            else
              echo "âŒ Scripts de gerenciamento nÃ£o encontrados!"
              exit 1
            fi

            # Dar permissÃ£o de execuÃ§Ã£o aos scripts
            chmod +x *.sh

            # Iniciar sistema
            echo "ğŸš€ Iniciando sistema atualizado..."
            ./start_all.sh

            # Aguardar inicializaÃ§Ã£o
            sleep 10

            # Verificar status final
            echo "ğŸ“Š Status final do sistema:"
            ./status.sh

            # Testar endpoints principais
            echo "ğŸ§ª Testando endpoints..."
            if curl -s http://localhost:3000 > /dev/null; then
              echo "âœ… Frontend funcionando (porta 3000)"
            else
              echo "âŒ Frontend nÃ£o responde (porta 3000)"
            fi

            if curl -s http://localhost:8000/status > /dev/null; then
              echo "âœ… RAG Server funcionando (porta 8000)"
            else
              echo "âŒ RAG Server nÃ£o responde (porta 8000)"
            fi

            if curl -s http://localhost:8001/status > /dev/null; then
              echo "âœ… API Server funcionando (porta 8001)"
            else
              echo "âŒ API Server nÃ£o responde (porta 8001)"
            fi

            echo ""
            echo "ğŸ‰ DEPLOY AUTOMÃTICO CONCLUÃDO - $(date)"
            echo "ğŸ“ Frontend: http://31.97.16.142:3000"
            echo "ğŸ“ RAG Server: http://31.97.16.142:8000"
            echo "ğŸ“ API Server: http://31.97.16.142:8001"
            echo "ğŸ“‹ Para verificar status: ./status.sh"
            echo "ğŸ“‹ Para ver logs: tail -f logs/*.log"
