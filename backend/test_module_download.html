<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste de Download Seletivo - DNA da For칞a</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 30px;
        }
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #34495e;
        }
        input, select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }
        button {
            background-color: #3498db;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        button:hover {
            background-color: #2980b9;
        }
        button:disabled {
            background-color: #bdc3c7;
            cursor: not-allowed;
        }
        .status {
            margin-top: 20px;
            padding: 15px;
            border-radius: 5px;
            font-weight: bold;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .modules-list {
            margin-top: 20px;
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 10px;
        }
        .module-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
        }
        .module-item:hover {
            background-color: #f8f9fa;
        }
        .module-item:last-child {
            border-bottom: none;
        }
        .progress {
            margin-top: 20px;
            background-color: #e9ecef;
            border-radius: 5px;
            overflow: hidden;
        }
        .progress-bar {
            height: 20px;
            background-color: #007bff;
            transition: width 0.3s ease;
            text-align: center;
            line-height: 20px;
            color: white;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>游빏 Download Seletivo de M칩dulos - DNA da For칞a</h1>
        
        <div class="form-group">
            <label for="folderId">ID da Pasta do Google Drive:</label>
            <input type="text" id="folderId" value="1s00SfrQ04z0YIheq1ub0Dj1GpA_3TVNJ" placeholder="Cole o ID da pasta aqui">
        </div>

        <div class="form-group">
            <label for="moduleSelect">M칩dulo Espec칤fico (opcional):</label>
            <select id="moduleSelect">
                <option value="">-- Todos os m칩dulos (profundidade limitada) --</option>
            </select>
        </div>

        <div class="form-group">
            <label for="maxDepth">Profundidade M치xima:</label>
            <select id="maxDepth">
                <option value="1">1 - Apenas pasta raiz</option>
                <option value="2" selected>2 - Pasta + subpastas</option>
                <option value="3">3 - Pasta + subpastas + arquivos</option>
            </select>
        </div>

        <div class="form-group">
            <button onclick="listModules()">游닄 Listar M칩dulos Dispon칤veis</button>
            <button onclick="downloadModule()">拘勇 Baixar M칩dulo</button>
            <button onclick="checkProgress()">游늵 Verificar Progresso</button>
        </div>

        <div id="status" class="status" style="display: none;"></div>
        
        <div id="progress" class="progress" style="display: none;">
            <div id="progressBar" class="progress-bar" style="width: 0%">0%</div>
        </div>

        <div id="modulesList" class="modules-list" style="display: none;"></div>
    </div>

    <script>
        let currentDownloadId = null;
        let progressInterval = null;

        async function listModules() {
            const folderId = document.getElementById('folderId').value;
            if (!folderId) {
                showStatus('Por favor, insira o ID da pasta', 'error');
                return;
            }

            showStatus('Listando m칩dulos...', 'info');
            
            try {
                const response = await fetch(`/drive/list-modules?folder_id=${folderId}`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${getToken()}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    displayModules(data.modules);
                    showStatus(`Encontrados ${data.total_modules} m칩dulos`, 'success');
                } else {
                    const error = await response.text();
                    showStatus(`Erro ao listar m칩dulos: ${error}`, 'error');
                }
            } catch (error) {
                showStatus(`Erro de conex칚o: ${error.message}`, 'error');
            }
        }

        function displayModules(modules) {
            const modulesList = document.getElementById('modulesList');
            const moduleSelect = document.getElementById('moduleSelect');
            
            // Limpar sele칞칚o atual
            moduleSelect.innerHTML = '<option value="">-- Todos os m칩dulos (profundidade limitada) --</option>';
            
            // Adicionar m칩dulos  lista
            modulesList.innerHTML = '';
            modules.forEach(module => {
                // Adicionar ao select
                const option = document.createElement('option');
                option.value = module.name;
                option.textContent = module.name;
                moduleSelect.appendChild(option);
                
                // Adicionar  lista visual
                const moduleItem = document.createElement('div');
                moduleItem.className = 'module-item';
                moduleItem.textContent = module.name;
                moduleItem.onclick = () => {
                    moduleSelect.value = module.name;
                };
                modulesList.appendChild(moduleItem);
            });
            
            modulesList.style.display = 'block';
        }

        async function downloadModule() {
            const folderId = document.getElementById('folderId').value;
            const moduleName = document.getElementById('moduleSelect').value;
            const maxDepth = parseInt(document.getElementById('maxDepth').value);

            if (!folderId) {
                showStatus('Por favor, insira o ID da pasta', 'error');
                return;
            }

            showStatus('Iniciando download...', 'info');
            showProgress();

            try {
                const response = await fetch('/drive/download-module', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${getToken()}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        folder_id: folderId,
                        module_name: moduleName || null,
                        max_depth: maxDepth,
                        download_files: true
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    currentDownloadId = data.download_id;
                    showStatus(`Download iniciado: ${data.message}`, 'success');
                    
                    // Iniciar monitoramento de progresso
                    startProgressMonitoring();
                } else {
                    const error = await response.text();
                    showStatus(`Erro ao iniciar download: ${error}`, 'error');
                    hideProgress();
                }
            } catch (error) {
                showStatus(`Erro de conex칚o: ${error.message}`, 'error');
                hideProgress();
            }
        }

        async function checkProgress() {
            if (!currentDownloadId) {
                showStatus('Nenhum download ativo', 'info');
                return;
            }

            try {
                const response = await fetch(`/drive/download-progress?download_id=${currentDownloadId}`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${getToken()}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    updateProgress(data);
                    showStatus(`Status: ${data.status}`, 'info');
                } else {
                    const error = await response.text();
                    showStatus(`Erro ao verificar progresso: ${error}`, 'error');
                }
            } catch (error) {
                showStatus(`Erro de conex칚o: ${error.message}`, 'error');
            }
        }

        function startProgressMonitoring() {
            if (progressInterval) {
                clearInterval(progressInterval);
            }
            
            progressInterval = setInterval(async () => {
                try {
                    const response = await fetch(`/drive/download-progress?download_id=${currentDownloadId}`, {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${getToken()}`,
                            'Content-Type': 'application/json'
                        }
                    });

                    if (response.ok) {
                        const data = await response.json();
                        updateProgress(data);
                        
                        if (data.status === 'completed' || data.status === 'error') {
                            clearInterval(progressInterval);
                            progressInterval = null;
                            
                            if (data.status === 'completed') {
                                showStatus('Download conclu칤do com sucesso!', 'success');
                            } else {
                                showStatus(`Erro no download: ${data.error}`, 'error');
                            }
                        }
                    }
                } catch (error) {
                    console.error('Erro ao monitorar progresso:', error);
                }
            }, 2000); // Verificar a cada 2 segundos
        }

        function updateProgress(data) {
            const progressBar = document.getElementById('progressBar');
            const progress = data.progress || 0;
            
            progressBar.style.width = `${progress}%`;
            progressBar.textContent = `${progress}%`;
            
            if (data.current_file) {
                showStatus(`Baixando: ${data.current_file}`, 'info');
            }
        }

        function showProgress() {
            document.getElementById('progress').style.display = 'block';
        }

        function hideProgress() {
            document.getElementById('progress').style.display = 'none';
        }

        function showStatus(message, type) {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = `status ${type}`;
            status.style.display = 'block';
        }

        function getToken() {
            // Em produ칞칚o, voc칡 deve implementar uma forma segura de obter o token
            // Por enquanto, vamos usar um token fixo para teste
            return 'seu_token_aqui';
        }

        // Carregar m칩dulos automaticamente ao abrir a p치gina
        window.onload = function() {
            if (document.getElementById('folderId').value) {
                listModules();
            }
        };
    </script>
</body>
</html>
